<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
             "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fund.mapper.CommitmentDetailMapper">

	<select id="selectByCommitmentID3" resultType="fund.dto.CommitmentDetail">
	select *
	from CommitmentDetail
	where commitmentID = #{commitmentID}
	</select>
	
	<select id="selectByCommitmentID2" resultType="fund.dto.CommitmentDetail">
	select *
	from CommitmentDetail
	where commitmentID = #{commitmentID}
	
	</select>
	
	<select id="selectCommitmentID" resultType="int">
	select MAX(ID)
	from Commitment 
	</select>
    
   <select id="selectByCommitmentID" resultType="fund.dto.CommitmentDetail">
   	SELECT c2.*
   	FROM Commitment c1 left join CommitmentDetail c2 on c1.ID=c2.commitmentID 
   	WHERE c1.ID=#{id}
   </select>
   
   <insert id="insert" useGeneratedKeys="true" keyProperty="ID">
        INSERT CommitmentDetail
               (commitmentID, amountPerMonth, paymentDay, startDate, bankID, accountNo, accountHolder, etc)
        VALUES (#{commitmentID}, #{amountPerMonth}, #{paymentDay}, #{startDate}, #{bankID}, #{accountNo}, #{accountHolder}, #{etc})
    </insert>
 
    
    <update id="update">
        UPDATE CommitmentDetail
        SET amountPerMonth = #{amountPerMonth}, 
        	  paymentDay = #{paymentDay},
              bankID = #{bankID},
              accountNo = #{accountNo}, 
              accountHolder = #{accountHolder}, 
              startDate = #{startDate,jdbcType=DATE},
              etc = #{etc}
        WHERE ID = #{ID}
    </update>
    
    <delete id="delete">
    delete from CommitmentDetail
    where ID=#{ID}
    </delete>
    
    <select id="selectEB21" resultType="fund.dto.EB21_commitmentDetail">
    	select s.sponsorNo,cd.accountHolder,LEFT(s.juminNo,6) jumin,code.codeName,cd.accountNo,cd.amountPerMonth,code.etc1,cd.ID commitmentDetailID
		from [commitmentDetail] cd
		JOIN [EB13_commitmentDetail] eb
		ON eb.state='성공' AND cd.ID=eb.commitmentDetailID
		LEFT JOIN [commitment] c
		ON cd.commitmentID=c.ID AND c.paymentMethodID=10
		AND (c.endDate is null OR c.endDate>GETDATE())
		JOIN [sponsor] s
		ON c.sponsorID=s.ID
		JOIN [code]
		ON cd.bankID=code.ID
		WHERE cd.paymentDay=#{pDay}
		AND
		cd.ID
		NOT IN (select commitmentDetailID from EB21_commitmentDetail)
		AND cd.ID IN 
		(SELECT MAX(ID) FROM commitmentDetail 
		GROUP BY commitmentID)
	</select>
	
	<select id="selectEB13" resultType="fund.dto.EB13_CommitmentDetail">
	    select s.sponsorNo,cd.accountHolder,juminNo jumin2,codeName,cd.accountNo,cd.ID commitmentDetailID,code.etc1
		from [commitmentDetail] cd
		INNER JOIN [code]
		ON cd.bankID=code.ID
		LEFT JOIN [commitment] c
		ON cd.commitmentID=c.ID
		LEFT JOIN [sponsor] s
		ON c.sponsorID=s.ID
		where cd.ID
		not in (select commitmentDetailID from [EB13_commitmentDetail])
		AND c.paymentMethodID=10
		AND cd.ID IN 
		(SELECT MAX(ID) FROM commitmentDetail 
		GROUP BY commitmentID)
    </select>
	
</mapper>
