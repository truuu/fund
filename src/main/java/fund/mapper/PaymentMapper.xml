<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
             
<mapper namespace="fund.mapper.PaymentMapper">

<sql id="select1">
  SELECT p.*,
    co.name corporateName, og.codeName organizationName, dp.name donationPurposeName, me.codeName paymentMethodName,
    c.commitmentNo, c.accountNo, c.accountHolder,
    bk.codeName bankName
  FROM payment p
    LEFT JOIN code me ON me.id = p.paymentMethodId 
    LEFT JOIN donationPurpose dp ON p.donationPurposeId = dp.id
    LEFT JOIN code og ON og.id = dp.organizationId 
    LEFT JOIN corporate co ON dp.corporateId = co.id
    LEFT JOIN commitment c ON p.commitmentId = c.id
    LEFT JOIN code bk ON bk.id = c.bankId
</sql>

<select id="selectById" resultType="fund.dto.Payment">
  <include refid="select1"></include>
  WHERE p.id = #{id}
</select>

<select id="selectPaymentList1" resultType="fund.dto.Payment">
  <include refid="select1"></include>
  WHERE p.commitmentId = #{commitmentId}
  ORDER BY p.paymentDate
</select>

<select id="selectPaymentList2" resultType="fund.dto.Payment">
  <include refid="select1"></include>
  WHERE p.sponsorId = #{sponsorId}
  AND me.codeGroupId = 4
  ORDER BY p.paymentDate
</select>

<update id="update">    
  UPDATE Payment
    SET 
      receiptId = #{receiptId},
      amount = #{amount}, 
      paymentDate = #{paymentDate}, 
      donationPurposeId = #{donationPurposeId}, 
      paymentMethodId = #{paymentMethodId},
      etc = #{etc}
  FROM Payment
  WHERE id = #{id}
</update>

<delete id="delete">
  DELETE FROM Payment WHERE id = #{id}
</delete>

<insert id="insert" useGeneratedKeys="true" keyProperty="id">
  INSERT payment(sponsorId, commitmentId, amount, paymentDate, etc, receiptId, donationPurposeId, paymentMethodId)
  VALUES (#{sponsorId}, #{commitmentId}, #{amount}, #{paymentDate}, #{etc}, #{receiptId}, #{donationPurposeId}, #{paymentMethodId})
</insert>

<select id="selectForReceiptCreation1" resultType="fund.dto.Payment">
DECLARE @srchText NVARCHAR(50), @startDate DATE, @endDate DATE, @corporateId INT
SET @srchText = #{srchText}
SET @startDate = #{startDate}
SET @endDate = #{endDate}
SET @corporateId = #{corporateId}
SELECT p.*, s.sponsorNo, s.name, r.[no] 'receiptNo'
FROM Payment p 
  LEFT JOIN Sponsor s ON p.sponsorId = s.id 
  LEFT JOIN Receipt r ON p.receiptId = r.id
WHERE p.paymentDate BETWEEN @startDate AND @endDate
AND p.sponsorId IN (SELECT id FROM [sponsor] WHERE name = @srchText)
AND p.donationPurposeId IN (SELECT id FROM donationPurpose WHERE @corporateId = 0 OR corporateId = @corporateId)
ORDER BY p.paymentDate DESC
</select>

<select id="selectForReceiptCreation2" resultType="fund.dto.Payment">
DECLARE @startDate DATE, @endDate DATE
SET @startDate = #{startDate}
SET @endDate = #{endDate}

SELECT p.*, d.corporateId
FROM Payment p 
  LEFT JOIN donationPurpose d ON d.id = p.donationPurposeId
WHERE p.paymentDate BETWEEN @startDate AND @endDate
AND p.receiptId IS NULL
ORDER BY p.sponsorId, d.corporateId
</select>    

<select id="selectByReceiptId" resultType="fund.dto.Payment">
  SELECT * FROM payment WHERE receiptId = #{receiptId}
</select>

<select id="selectForTaxData" resultType="fund.dto.Payment">
DECLARE @startDate DATE, @endDate DATE, @corporateId INT
SET @startDate = #{startDate}
SET @endDate = #{endDate}
SET @corporateId = #{corporateId}
SELECT p.*, s.sponsorNo, s.name sponsorName, 
  CONVERT(VARCHAR, DECRYPTBYPASSPHRASE(CONVERT(VARCHAR, ${key1}), juminNo_encrypted)) juminNo
FROM payment p 
  LEFT JOIN sponsor s ON s.id = p.sponsorId
  LEFT JOIN donationPurpose d ON d.id = p.donationPurposeId
WHERE paymentDate BETWEEN @startDate AND @endDate
AND corporateId = @corporateId
AND receiptId IS NOT NULL
</select>

</mapper>
