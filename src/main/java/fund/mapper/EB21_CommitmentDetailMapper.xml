<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
             "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fund.mapper.EB21_CommitmentDetailMapper">
	
	<select id="selectEB21success" resultType="fund.dto.Payment">
    	select c.sponsorID,c.ID commitmentID,e.paymentDate,c.donationPurposeID,c.paymentMethodID,cd.amountPerMonth
		from EB21_commitmentDetail eb
		JOIN commitmentDetail cd
		ON eb.commitmentDetailID=cd.ID
		JOIN commitment c
		ON cd.commitmentID=c.ID
		JOIN EB21 e ON e.ID=eb.EB21ID
		where eb.state='성공'
    </select>
	
	<select id="selectEB22" resultType="fund.dto.EB21">
		select * from EB21_commitmentDetail
		where EB21ID
		in (select ID
		from EB21 
		where EB21.paymentDate=#{paymentDay})			
	</select>
	
	<update id="updateEB21error">
		update EB21_commitmentDetail set state='에러'
		where commitmentDetailID IN
		(select cd.ID
		from EB21_commitmentDetail eb
		JOIN commitmentDetail cd
		ON eb.commitmentDetailID=cd.ID
		JOIN commitment c
		ON cd.commitmentID=c.ID
		JOIN sponsor s
		ON c.sponsorID=s.ID
		JOIN EB21 e
		ON e.paymentDate=#{paymentDate}
		where s.sponsorNo=#{sponsorNo})
	</update>
	
	<update id="updateEB21success">
		update EB21_commitmentDetail 
		set state='성공'
		where state NOT IN
		(select state from EB21_commitmentDetail
		where state='에러')
		AND
		EB21ID IN
		(select e.ID
		from EB21 e
		where e.paymentDate=#{paymentDate})
	</update>
	
	<select id="selectEB2122" resultType="fund.dto.EB21_commitmentDetail">
		<![CDATA[ 
			select e.createDate,s.sponsorNo,s.name,c.commitmentNo,eb.state,d.name donationPurpose
			from EB21_commitmentDetail eb JOIN commitmentDetail cd
			ON eb.commitmentDetailID=cd.ID
			JOIN EB21 e
			ON eb.EB21ID=e.ID
			INNER JOIN code
			ON cd.bankID=code.ID
			LEFT JOIN commitment c
			ON cd.commitmentID=c.ID
			LEFT JOIN sponsor s
			ON c.sponsorID=s.ID
			JOIN donationPurpose d
			ON c.donationPurposeID=d.ID
			WHERE e.paymentDate >= #{startDate} AND e.createDate <= #{endDate}
		]]> 
	</select>
	
	<insert id="createEB21List" useGeneratedKeys="true" keyProperty="id">
		insert into EB21_commitmentDetail
		values ((select MAX(ID) from EB21),#{commitmentDetailID},'신청') 
	</insert>
</mapper>
