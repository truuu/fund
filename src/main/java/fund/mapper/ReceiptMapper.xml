<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
             "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fund.mapper.ReceiptMapper">

<select id="selectById" resultType="fund.dto.Receipt">
SELECT * FROM [Receipt] WHERE id = #{id}
</select>

<select id="selectPage" resultType="hashmap">
<![CDATA[
DECLARE @nm NVARCHAR(50), @sd VARCHAR(50), @ed VARCHAR(50), @currentPage INT, @pageSize INT
SET @nm = #{srchText}
SET @sd = #{sd}
SET @ed = #{ed}
SET @currentPage = #{currentPage}
SET @pageSize = #{pageSize}

SELECT *
FROM ( 
  SELECT r.*, s.name, s.sponsorNo, s.mobilePhone,
    ROW_NUMBER() OVER (ORDER BY r.id DESC) 행번호, 
    (SELECT SUM(p.amount) FROM payment p WHERE p.receiptId = r.id) amount
  FROM Receipt r 
    LEFT JOIN [Sponsor] s ON r.sponsorId = s.id
  WHERE (@nm = '' OR @nm IS NULL OR CHARINDEX(@nm, s.name) = 1) 
  AND (@sd = '' OR @sd IS NULL OR r.createDate BETWEEN @sd AND @ed)
) subquery
WHERE 
  행번호 > (@currentPage - 1) * @pageSize AND
  행번호 <= @currentPage * @pageSize
ORDER BY 행번호
]]>
</select>

<select id="selectCount" resultType="int">
DECLARE @nm NVARCHAR(50), @sd VARCHAR(50), @ed VARCHAR(50), @currentPage INT, @pageSize INT
SET @nm = #{srchText}
SET @sd = #{sd}
SET @ed = #{ed}

SELECT COUNT(*)
FROM [Receipt] r 
  LEFT JOIN Sponsor s ON r.sponsorId = s.id
WHERE (@nm = '' OR @nm IS NULL OR CHARINDEX(@nm, s.name) = 1) 
AND (@sd = '' OR @sd IS NULL OR r.createDate BETWEEN @sd AND @ed)
</select>

<select id="generateReceiptNo" resultType="java.lang.String">
DECLARE @n INT, @year CHAR(4)
SET @year = SUBSTRING(#{createDate}, 1, 4)
SET @n = (
  SELECT MAX(CONVERT(INT, RIGHT([no],4)))
  FROM receipt
  WHERE CHARINDEX(@year, [no]) = 1 AND LEN([no]) = 9
  AND ISNUMERIC(RIGHT([no], 4)) = 1)
SET @n = ISNULL(@n,0) + 1
SELECT @year + '-' + REPLACE(STR(@n, 4), ' ', '0')
</select>

<insert id="insert" useGeneratedKeys="true" keyProperty="id">
INSERT INTO Receipt (sponsorId, createDate, [no])
VALUES( #{sponsorId},#{createDate},#{no})
</insert>

<delete id="deleteById">
DELETE FROM [Receipt] WHERE id = #{id}
</delete>
    
</mapper>
