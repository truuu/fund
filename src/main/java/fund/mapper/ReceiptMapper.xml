<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
             "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fund.mapper.ReceiptMapper">

<select id="selectPage" resultType="fund.dto.Receipt">
<![CDATA[
DECLARE @srchType INT, @srchText NVARCHAR(50), @currentPage INT, @pageSize INT
SET @srchType = #{srchType}
SET @srchText = #{srchText}
SET @pageSize = #{pageSize}
SET @currentPage = #{currentPage}

SELECT *
FROM ( 
  SELECT r.id, r.[no], s.name, s.juminNo, s.mobilePhone, r.createDate,
    ROW_NUMBER() OVER (ORDER BY r.id DESC) 행번호, SUM(p.amount) amount
  FROM Receipt r 
    LEFT JOIN [Sponsor] s ON r.sponsorId = s.id
    LEFT JOIN [Payment] p ON r.id=p.receiptId
  WHERE
    (@srchType = 0) OR
    (@srchType = 1 AND CHARINDEX(@srchText, s.name) = 1)
  GROUP BY r.id,r.[no],s.name,s.juminNo, s.mobilePhone, r.createDate
) subquery
WHERE 
  행번호 > (@currentPage - 1) * @pageSize AND
  행번호 <= @currentPage * @pageSize
ORDER BY 행번호
]]>
</select>

<select id="selectCount" resultType="int">
DECLARE @srchType INT, @srchText NVARCHAR(50)
SET @srchType = 0
SET @srchText = null

SELECT COUNT(*)
FROM [Receipt] r 
  LEFT JOIN Sponsor s ON r.sponsorId = s.id
  LEFT JOIN Payment p ON r.id = p.receiptId
WHERE
  (@srchType = 0) OR
  (@srchType = 1 AND CHARINDEX(@srchText, s.name) = 1 )
</select>

<select id="generateReceiptNo" resultType="java.lang.String">
  DECLARE @n INT, @year CHAR(4)
  SET @year = SUBSTRING(#{createDate}, 1, 4)
  SET @n = (
    SELECT MAX(CONVERT(INT, RIGHT([no],4)))
    FROM receipt
    WHERE CHARINDEX(@year, [no]) = 1 AND LEN([no]) = 9
    AND ISNUMERIC(RIGHT([no], 4)) = 1)
  SET @n = ISNULL(@n,0) + 1
  SELECT @year + '-' + REPLACE(STR(@n, 4), ' ', '0')
</select>

<insert id="insert" useGeneratedKeys="true" keyProperty="id">
  INSERT INTO Receipt (sponsorId, createDate, [no])
  VALUES( #{sponsorId},#{createDate},#{no})
</insert>
    
	
  
	<select id="selectRctID" resultType="int">
		SELECT top 1 id
		FROM [Receipt]
		ORDER BY id DESC
	</select>

	<select id="selectById" resultType="fund.dto.Receipt">
		SELECT *
		FROM [Receipt]
		WHERE id=#{id}
	</select>
	
	<select id="selectByNo" resultType="fund.dto.Receipt">
		SELECT * FROM [Receipt] WHERE [no]=#{no}
	</select>
	
	<select id="selectReceiptList" resultType="fund.dto.Receipt">
		SELECT receipt.no,sponsor.name,sponsor.juminNo,sponsor.mobilePhone
		FROM [Receipt] JOIN [Sponsor] ON receipt.sponsorId=sponsor.id 
					JOIN [Payment] ON receipt.id=payment.receiptId 
	</select>
	

	
	<select id="getRid" resultType="int">
		SELECT max(id) FROM [Receipt]
	</select>
	
	<select id="getLastNo" resultType="String">
		SELECT top 1 [no]
		FROM [Receipt]
		WHERE [no] LIKE #{year}+'%'
		ORDER BY id DESC
	</select>
    
    
    <delete id="deleteByNo">
    	DELETE FROM [Receipt] WHERE [no]=#{no}
    </delete>
    
    <delete id="deleteById">
    	DELETE FROM [Receipt] WHERE id=#{id}
    </delete>

</mapper>
