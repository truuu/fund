<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
             "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fund.mapper.EB13_CommitmentDetailMapper">

	<select id="selectEB14" resultType="fund.dto.EB13_CommitmentDetail">
		select * from EB13_commitmentDetail
		where EB13ID
		in (select ID
		from EB13 
		where EB13.createDate=#{createDate})
	</select>
	
	<update id="updateEB14error">
		update EB13_commitmentDetail set state='에러', errorCode=#{errorCode}
		where commitmentDetailID IN
		(select cd.id
		from EB13_commitmentDetail eb
		JOIN commitmentDetail cd
		ON eb.commitmentDetailID=cd.id
		JOIN commitment c
		ON cd.commitmentId=c.id
		JOIN sponsor s
		ON c.sponsorId=s.id
		where s.sponsorNo=#{sponsorNo})
	</update>
	
	<update id="updateEB14success">
		update EB13_commitmentDetail set state='성공'
		where state NOT IN
		(select state from EB13_commitmentDetail
		where state='에러')
		AND
		EB13ID IN
		(select e.id
		from EB13 e
		where e.createDate=#{createDate})

	</update>
	
	<select id="selectEB1314" resultType="fund.dto.EB13_CommitmentDetail">
		<![CDATA[ 
			select e.createDate,s.sponsorNo,s.name,c.commitmentNo,eb.state,cec.description,d.name donationPurpose
			from EB13_commitmentDetail eb JOIN commitmentDetail cd
			ON EB.commitmentDetailID=CD.id
			JOIN EB13 e
			ON eb.EB13ID=e.id
			INNER JOIN code
			ON cd.bankID=code.id
			LEFT JOIN commitment c
			ON cd.commitmentId=c.id
			LEFT JOIN sponsor s
			ON c.sponsorId=s.id
			JOIN donationPurpose d
			ON c.donationPurposeID=d.id
			LEFT JOIN cmsErrorCode cec
			ON eb.errorCode = cec.code
			WHERE e.createDate >= #{startDate} AND e.createDate <= #{endDate}
		]]> 
	</select>
	
	<insert id="createEB13list" useGeneratedKeys="true" keyProperty="id">
	    insert into EB13_commitmentDetail
		values ((select MAX(ID) from EB13),#{commitmentDetailID},'신규','0000')     
    </insert>
	
	<select id="test" resultType="fund.dto.EB13_CommitmentDetail">
		select * from EB13_commitmentDetail
	</select>
	
</mapper>